<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Add Task | TimeMate</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Custom CSS + Fonts -->
    <script type="module" src="/src/app.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap"
      rel="stylesheet"
    />

    <!-- Components -->
    <script type="module" src="./src/components/site-navbar.js"></script>
    <script type="module" src="./src/components/site-footer.js"></script>
  </head>

  <body class="body-bg">
    <site-navbar></site-navbar>

    <div class="container py-5" style="max-width: 480px">
      <h3 class="text-center mb-4">Add New Task</h3>

      <form id="addEventForm" class="bg-light p-4 rounded shadow-sm">
        <div class="mb-3">
          <label for="eventName" class="form-label">Task Name</label>
          <input
            type="text"
            class="form-control"
            id="eventName"
            placeholder="e.g. Dinner with team"
            required
          />
        </div>

        <div class="mb-3">
          <label for="eventDescription" class="form-label">Description</label>
          <textarea
            class="form-control"
            id="eventDescription"
            rows="4"
            placeholder="Add details about your event (press Enter for new line)..."
          ></textarea>
        </div>

        <div class="mb-3">
          <label for="eventDate" class="form-label">Task Date</label>
          <input type="date" class="form-control" id="eventDate" required />
        </div>

        <button type="submit" class="btn btn-primary w-100">Add Task</button>
      </form>
    </div>

    <site-footer></site-footer>

    <script type="module">
      import {
        addTaskForCurrentUser,
        getTaskById,
        updateTask,
      } from "./src/tasksClient.js";

      const urlParams = new URLSearchParams(window.location.search);
      const taskId = urlParams.get("id");

      document.addEventListener("DOMContentLoaded", async () => {
        const form = document.getElementById("addEventForm");
        const titleInput = document.getElementById("eventName");
        const descInput = document.getElementById("eventDescription");
        const dateInput = document.getElementById("eventDate");
        const title = document.querySelector("h3");
        const submitBtn = document.querySelector("button[type='submit']");

        if (taskId) {
          title.textContent = "Edit Task";
          submitBtn.textContent = "Save Changes";

          try {
            const task = await getTaskById(taskId);
            titleInput.value = task.title || "";
            descInput.value = task.description || "";
            if (task.dueDate?.seconds) {
              dateInput.value = new Date(task.dueDate.seconds * 1000)
                .toISOString()
                .split("T")[0];
            }
          } catch (err) {
            console.error("Failed to load task:", err);
            alert("Could not load task for editing.");
          }
        }

        // when form submit
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const taskData = {
            title: titleInput.value.trim(),
            description: descInput.value.trim(),
            dueDate: dateInput.value ? new Date(dateInput.value) : null,
          };

          try {
            if (taskId) {
              //
              await updateTask(taskId, taskData);
            } else {
              //
              await addTaskForCurrentUser(taskData);
              alert("Task added successfully!");
            }

            // back to event list
            window.location.href = "event.html";
          } catch (err) {
            console.error("Failed to save task:", err);
            alert("Failed to save task. Please make sure you are signed in.");
          }
        });
      });
    </script>
  </body>
</html>
