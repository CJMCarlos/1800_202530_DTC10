<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Events | TimeMate</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Custom CSS + Fonts -->
    <script type="module" src="/src/app.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap"
      rel="stylesheet"
    />

    <!-- Components -->
    <script type="module" src="./src/components/site-navbar.js"></script>
    <script type="module" src="./src/components/site-footer.js"></script>
  </head>

  <body class="body-bg">
    <site-navbar></site-navbar>

    <div class="container py-5" style="max-width: 480px">
      <h3 class="text-center mb-4">My Events</h3>

      <div id="eventList" class="p-3 bg-light rounded shadow-sm border">
        <div id="loadingTasks" class="text-center">
          <p class="text-muted m-0">Loading tasks...</p>
        </div>
      </div>

      <div class="d-flex justify-content-end mt-4">
        <button id="addEventBtn" class="btn btn-success px-4">
          + Add Task
        </button>
      </div>
    </div>

    <site-footer></site-footer>
    <script type="module">
      import { listenToUserTasks } from "./src/tasksClient.js";
      import { onAuthReady } from "./src/authentication.js";

      document.addEventListener("DOMContentLoaded", () => {
        const addEventBtn = document.getElementById("addEventBtn");
        const eventList = document.getElementById("eventList");
        const loadingDiv = document.getElementById("loadingTasks");

        addEventBtn.addEventListener("click", () => {
          window.location.href = "add-event.html";
        });

        // Start listening for tasks when user is authenticated
        onAuthReady((user) => {
          if (!user) {
            loadingDiv.innerHTML =
              '<p class="text-muted m-0">Please sign in to view your tasks</p>';
            return;
          }

          // Listen for tasks in real-time
          listenToUserTasks((tasks) => {
            if (tasks.length === 0) {
              eventList.innerHTML =
                '<p class="text-muted text-center m-0">No tasks yet</p>';
              return;
            }

            // Render tasks
            const tasksHtml = tasks
              .map(
                (task) => `
              <div class="task-item mb-3 p-3 border rounded bg-white">
                <div class="d-flex align-items-center justify-content-between">
                  <h5 class="mb-1">${task.title}</h5>
                  <small class="text-muted">${
                    task.dueDate
                      ? new Date(
                          task.dueDate.seconds * 1000
                        ).toLocaleDateString()
                      : "No due date"
                  }</small>
                </div>
                ${
                  task.description
                    ? `<p class="mb-0 text-muted">${task.description}</p>`
                    : ""
                }
              </div>
            `
              )
              .join("");

            eventList.innerHTML = tasksHtml;
          });
        });
      });
    </script>
  </body>
</html>
